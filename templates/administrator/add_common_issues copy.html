{% extends 'administrator/base.html' %}
{% load static %}
{% block title %}
<title>Add Customer Issues</title>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/style_add_common_issue.css' %}">
{% endblock %}

{% block content %}
{% if messages %}
{% for msg in messages %}
<script>
  alert('{{msg}}');
</script>
{% endfor %}
{% endif %}
<div class="mx-auto container d-flex">
<div class="form-container row md-5">
  <h3 class="mb-3 text-center fw-bold">Report Customer Issues</h3>
  <form method="post" action="{% url 'administrator:add-issues' %}" id="issueForm">
    {% csrf_token %}

    <!-- Product Selection -->
    <div class="mb-3">
      <label for="product" class="form-label fw-semibold">Select Product</label>
      <select class="form-select" id="product" name="product" required>
        <option value="">-- Choose a product --</option>
        {% if products %}
        {% for product in products %}
        <option value="{{product.id}}">{{product.product}}</option>
        {% endfor %}
        {% endif %}
      </select>
    </div>

    <!-- Issues Section -->
    <div id="issueContainer">
      <div class="input-group mb-3 issue-box">
        <input type="text" name="issue_1" class="form-control issue-input" placeholder="Describe the issue (min 5 characters)" minlength="5" required>
        <button type="button" class="btn add-issue" title="Add Issue">
          <i class="bi bi-plus-circle"></i>
        </button>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="d-grid mt-3">
      <button type="submit" class="btn btn-primary">Submit</button>
    </div>
  </form>
</div>
<div class="row md-7">
    <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Product</th>
            <th scope="col">Issue</th>
            <th scope="col">Edit</th>
            <th scope="col">Delete</th>
          </tr>
        </thead>
        <tbody>
          {% if issues.count > 1 %}
          {% for issue in issues %}
          <tr>
            <th>{{ forloop.counter }}</th>
            <td>{{issue.product}}</td>
            <td>{{issue.issue}}</td>
            <td><a href="{% url 'administrator:edit_issue' %}?id={{issue.id}}"><input type="button" class="btn btn-warning" value="Edit"></a></td>
            <td><a href="{% url 'administrator:delete_issue' issue.id %}"><input type="button" class="btn btn-danger" value="Delete"></a></td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
           <td colspan="5">No records to show</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
</div>
</div>

<!-- JS for adding/removing issue fields -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
      const container = document.getElementById("issueContainer");
      const maxIssues = 5;
      let issueCount = 1;
  
      function createIssueBox(count) {
          const issueBox = document.createElement('div');
          issueBox.className = 'input-group mb-3 issue-box';
          issueBox.innerHTML = `
              <input type="text" name="issue_${count}" class="form-control issue-input" placeholder="Describe the issue (min 5 characters)" minlength="5" required>
              <button type="button" class="btn btn-outline-danger remove-issue" title="Remove Issue">
                  <i class="bi bi-dash-circle"></i>
              </button>
              <button type="button" class="btn btn-outline-success add-issue" title="Add Issue">
                  <i class="bi bi-plus-circle"></i>
              </button>
          `;
          return issueBox;
      }
  
      container.addEventListener("click", function (e) {
          if (e.target.closest(".add-issue")) {
              if (issueCount < maxIssues) {
                  issueCount++;
                  const newIssue = createIssueBox(issueCount);
                  container.appendChild(newIssue);
                  updateButtons();
              } else {
                  alert("Maximum of 5 issues can be added");
              }
          } else if (e.target.closest(".remove-issue")) {
              if (container.querySelectorAll(".issue-box").length > 1) {
                  e.target.closest(".issue-box").remove();
                  issueCount--;
                  updateButtons();
              }
          }
      });
  
      function updateButtons() {
          const boxes = container.querySelectorAll(".issue-box");
          boxes.forEach((box, index) => {
              const addBtn = box.querySelector(".add-issue");
              const removeBtn = box.querySelector(".remove-issue");
              
              if (index === boxes.length - 1) {
                  addBtn.style.display = issueCount < maxIssues ? "block" : "none";
              } else {
                  addBtn.style.display = "none";
              }
              
              removeBtn.style.display = boxes.length > 1 ? "block" : "none";
          });
      }
  
      updateButtons();
  });
  
  // Search functionality
  function searchProductsAndIssues() {
      const searchInput = document.getElementById('searchInput');
      const filter = searchInput.value.toLowerCase();
      const productItems = document.querySelectorAll('.product-item');
  
      productItems.forEach(item => {
          const productName = item.querySelector('.accordion-button').textContent.toLowerCase();
          const issues = Array.from(item.querySelectorAll('.issue-text')).map(issue => issue.textContent.toLowerCase());
          
          const productMatch = productName.includes(filter);
          const issueMatch = issues.some(issue => issue.includes(filter));
  
          if (productMatch || issueMatch) {
              item.style.display = '';
              if (issueMatch && !productMatch) {
                  // Open accordion if issue matches but product name doesn't
                  const accordionButton = item.querySelector('.accordion-button');
                  const accordionCollapse = item.querySelector('.accordion-collapse');
                  accordionButton.classList.remove('collapsed');
                  accordionCollapse.classList.add('show');
              }
          } else {
              item.style.display = 'none';
          }
      });
  }
  </script>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %}